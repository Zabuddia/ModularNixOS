{% extends "base.html" %}
{% block title %}Admin Upload{% endblock %}
{% block content %}
<h2>Admin Upload</h2>
<div class="toolbar">
  <a class="btn btn-subtle" href="{{ url_for('admin.dashboard') }}">&larr; Back to Dashboard</a>
</div>

<section class="card stack">
  <h3>Generate CSV from HTML Table</h3>
  <form method="post" action="{{ url_for('admin.process_tables') }}" class="stack" data-busy="overlay">
    <label for="html_table">Paste HTML table</label>
    <textarea
      id="html_table"
      name="html_table"
      rows="12"
      placeholder="Paste full &lt;table&gt;...&lt;/table&gt; HTML here"
      required
    >{{ pasted_html|default('') }}</textarea>

    <div class="row">
      <label for="csv_filename">CSV filename:</label>
      <input
        type="text"
        id="csv_filename"
        name="csv_filename"
        placeholder="myfile.csv"
        value="{{ selected_filename|default('') }}"
      >
      <label for="baseline_id">Compare against:</label>
      <select name="baseline_id" id="baseline_id">
        <option value="" {% if not selected_baseline_id %}selected{% endif %}>— No baseline —</option>
        {% if baselines %}
          {% for b in baselines %}
            <option value="{{ b.id }}" {% if selected_baseline_id and (selected_baseline_id|string) == (b.id|string) %}selected{% endif %}>
              {{ b.filename }} — {{ b.generated_at | fmt_ny }}
            </option>
          {% endfor %}
        {% endif %}
      </select>
    </div>

    <button type="submit" class="btn">Build CSV from pasted HTML table</button>
  </form>
</section>

<section class="card stack mt">
  <h3>Generated CSVs</h3>
  <form
    method="post"
    action="{{ url_for('admin.upload_csv') }}"
    class="row"
    enctype="multipart/form-data"
    data-busy="overlay"
  >
    <input id="csv_file" name="csv_file" type="file" accept=".csv,text/csv" required>
    <button type="submit" class="btn">Upload .csv</button>
  </form>

  {% if csvs %}
    <ul class="list">
      {% for c in csvs %}
        <li data-csv-item="{{ c.id }}">
          <div class="stack">
            <strong>{{ c.filename }}</strong>
            <form
              method="post"
              action="{{ url_for('admin.rename_csv', csv_id=c.id) }}"
              class="row js-rename-form"
            >
              <input
                type="text"
                name="filename"
                value="{{ c.filename }}"
                aria-label="Rename {{ c.filename }}"
                required
              >
              <button type="submit" class="btn">Rename</button>
              <button type="button" class="btn btn-subtle js-cancel-rename">Cancel</button>
            </form>
            <span class="meta">
              ({{ c.generated_at | fmt_ny }}{{ ', ' + c.note if c.note else '' }})
            </span>
          </div>
          <span class="row">
            <button type="button" class="btn js-edit-rename">Edit name</button>
            <!-- Reorder controls -->
            <form method="post" action="{{ url_for('admin.csv_move_up', csv_id=c.id) }}">
              <button class="btn" title="Move up">↑</button>
            </form>
            <form method="post" action="{{ url_for('admin.csv_move_down', csv_id=c.id) }}">
              <button class="btn" title="Move down">↓</button>
            </form>
            <form method="post" action="{{ url_for('admin.csv_make_top', csv_id=c.id) }}">
              <button class="btn" title="Make primary">Make top</button>
            </form>

            <a class="btn" href="{{ url_for('admin.download_csv', csv_id=c.id) }}">Download</a>
            <form method="post"
                  action="{{ url_for('admin.delete_csv', csv_id=c.id) }}"
                  onsubmit="return confirm('Delete {{ c.filename or ("CSV " ~ c.id) }}? This cannot be undone.');">
              <button type="submit" class="linklike">Delete</button>
            </form>
          </span>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="meta">No CSVs generated yet.</p>
  {% endif %}
</section>

<script>
  (function () {
    document.addEventListener("click", function (event) {
      const editBtn = event.target.closest(".js-edit-rename");
      if (editBtn) {
        const item = editBtn.closest("[data-csv-item]");
        if (!item) return;
        const form = item.querySelector(".js-rename-form");
        const input = form ? form.querySelector("input[name='filename']") : null;
        if (!form) return;
        form.classList.add("is-open");
        if (input) {
          input.focus();
          input.select();
        }
        return;
      }

      const cancelBtn = event.target.closest(".js-cancel-rename");
      if (cancelBtn) {
        const form = cancelBtn.closest(".js-rename-form");
        if (!form) return;
        form.classList.remove("is-open");
      }
    });
  })();
</script>
{% endblock %}
